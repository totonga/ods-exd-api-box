FROM python:3.12-slim
LABEL org.opencontainers.image.source=https://github.com/totonga/ods-exd-api-box
LABEL org.opencontainers.image.description="Helper package to build ASAM ODS EXD API grpc plugins."
LABEL org.opencontainers.image.licenses=MIT
WORKDIR /app
# Create a non-root user and change ownership of /app
RUN useradd -ms /bin/bash appuser && chown -R appuser /app
# Copy source code first (needed for pip install)
COPY pyproject.toml .
COPY ods_exd_api_box/ ./ods_exd_api_box/
# Install required packages
RUN pip3 install --upgrade pip && pip3 install .
# Copy ASAM ODS Interface files into the container
# Download from ASAM ODS GitHub repository
ADD https://raw.githubusercontent.com/asam-ev/ASAM-ODS-Interfaces/main/ods.proto /app/
ADD https://raw.githubusercontent.com/asam-ev/ASAM-ODS-Interfaces/main/ods_external_data.proto /app/
# Use protoc to compile stubs in container
# overwrite existing pregenerated files to ensure compatibility with the used grpcio version
RUN python3 -m grpc_tools.protoc -I. --python_out=ods_exd_api_box/proto/. ods.proto
RUN python3 -m grpc_tools.protoc -I. --python_out=ods_exd_api_box/proto/. --grpc_python_out=ods_exd_api_box/proto/. ods_external_data.proto
# Convert absolute imports to relative imports
RUN sed -i 's/^import ods_pb2 as ods__pb2$/from . import ods_pb2 as ods__pb2/' ods_exd_api_box/proto/ods_external_data_pb2.py
RUN sed -i 's/^import ods_external_data_pb2 as ods__external__data__pb2$/from . import ods_external_data_pb2 as ods__external__data__pb2/' ods_exd_api_box/proto/ods_external_data_pb2_grpc.py
# should be copied at the end to avoid unnecessary rebuilds
COPY tests/external_data_file.py ./
USER appuser
# Start server
CMD [ "python3", "external_data_file.py"]
